{% extends "base.html" %}

{% load pipeline %}

{% block stylesheets %}
{{ block.super }}
{% stylesheet 'dashboards_play' %}
{% endblock stylesheets %}

{% block title %}Dashboard {{ dashboard.name }}{% endblock title %}
{% block h1 %}{{ dashboard.name }}{% endblock h1 %}

{% block breadcrumbs_nav %}
<div class="control pull-right">
    <div class="btn-group">
        <button type="button" class="btn-control dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="material-icons">more_horiz</i>
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
            {% if request.user.is_staff %}
            <li><a href="{% url 'dashboards_edit' dashboard.id %}">Edit</a></li>
            <li><a href="{% url 'dashboards_visualizations_new' dashboard.id %}">Add a visualization</a></li>
            {% if dashboard_entities|length > 1 %}
            <li><a href="{% url 'dashboards_sort' dashboard.id %}">Sort</a></li>
            <li><a href="{% url 'dashboards_export' dashboard.id %}">Export</a></li>
            {% endif %}
            <li role="separator" class="divider"></li>
            <li><a href="{% url 'dashboards_remove' dashboard.id %}">Delete</a></li>
            <li><a href="{% url 'dashboards_hard_remove' dashboard.id %}">Delete with visualizations</a></li>
            <li role="separator" class="divider"></li>
            {% endif %}
            {% if request.user in dashboard.star_users.all %}
            <li><a href="{% url 'dashboards_unstar' dashboard.id %}">Unstar</a></li>
            {% else %}
            <li><a href="{% url 'dashboards_star' dashboard.id %}">Star</a></li>
            {% endif %}
            {% if request.user.can_share %}
            <li role="separator" class="divider"></li>
            <li><a href="{% url 'dashboards_share' dashboard.id %}" id="shareDashboard">Share</a></li> 
            {% endif %}
        </ul>
    </div>
</div>
<ol class="breadcrumb">
    <li><a href="{% url 'dashboards_index' %}">Dashboards</a></li>
    <li class="active">{{ dashboard.name }}</li>
</ol>
{% endblock breadcrumbs_nav %}

{% block header %}
{{ block.super }}
<div class="star visible-md visible-lg">
    {% if request.user in dashboard.star_users.all %}
    <a href="{% url 'dashboards_unstar' dashboard.id %}">
        <i class="material-icons">star</i>
        <i class="material-icons hover">star_border</i>
    </a>
    {% else %}
    <a href="{% url 'dashboards_star' dashboard.id %}">
        <i class="material-icons">star_border</i>
        <i class="material-icons hover">star</i>
    </a>
    {% endif %}
</div>
{% endblock header %}

{% block container %}
{% include "dashboards/_play_row.html" %}
{% endblock container %}

{% block javascripts %}
{{ block.super }}
{% include "dashboards/_play_js.html" %}
<script>
function newModal(title, body, footer, size){
    var size = size || 'lg';
    var modal = $('<div>').attr('class', 'modal fade');
    var modalDialog = $('<div>').attr('class', 'modal-dialog').addClass('modal-' + size);
    var modalContent = $('<div>').attr('class', 'modal-content');
    var modalHeader = $('<div>').attr('class', 'modal-header');
    var closeButton = $('<button>').attr('class', 'close').attr('aria-label', 'Close').attr('data-dismiss', 'modal').append($('<span>').attr('aria-hidden', 'true').html('&times;'));
    var modalTitle = $('<h4>').attr('class', 'modal-title').html(title);
    var modalBody = $('<div>').attr('class', 'modal-body').append(body);
    modalHeader.append(closeButton);
    modalHeader.append(modalTitle);
    modalContent.append(modalHeader);
    modalContent.append(modalBody);
    modalDialog.append(modalContent);
    if (typeof footer != 'undefined' && footer) {
        var modalFooter = $('<div>').attr('class', 'modal-footer').html(footer);
        modalContent.append(modalFooter);
    }
    modal.append(modalDialog);
    modal.modal();
    return modal;
}
$('#shareDashboard').click(function(){
    $.ajax({
        url: $(this).attr('href'),
        success: function(data){
            console.log(data);
            var l1 = $('<label>').attr('class', 'col-sm-2 control-label').html('URL');
            var i1 = $('<div>').attr('class', 'col-sm-10').append($('<input>').attr('disabled', 'disabled').attr('class', 'form-control').attr('value', data.url));
            var r1 = $('<div>').attr('class', 'form-group').append(l1).append(i1);

            var l2 = $('<label>').attr('class', 'col-sm-2 control-label').html('Label');
            var i2 = $('<div>').attr('class', 'col-sm-10').append($('<input>').attr('name', 'label').attr('class', 'form-control'));
            var r2 = $('<div>').attr('class', 'form-group').append(l2).append(i2);

            var l3 = $('<label>').attr('class', 'col-sm-2 control-label').html('Valid days');
            var i3 = $('<div>').attr('class', 'col-sm-10').append($('<input>').attr('type', 'number').attr('name', 'days').attr('class', 'form-control').val(10));
            var r3 = $('<div>').attr('class', 'form-group').append(l3).append(i3);

            var form = $('<form>').attr('class', 'form-horizontal').append(r1).append(r2).append(r3);
            form.append($('<input>').attr('type', 'hidden').attr('name', 'id').val(data.id));

            var submitButton = $('<button>').html('Save').attr('class', 'btn btn-primary');
            var footer = $('<div>').append(submitButton);

            var modal = newModal('Share this dashboard', form, footer);

            submitButton.click(function(){
                $.ajax({
                    url: '{% url 'anonymous_update_shared_dashboard' %}',
                    data: form.serialize(),
                    type: 'post',
                    success: function(data){
                        modal.modal('hide');
                        var alert = $('<div>').addClass('alert alert-danger toast').attr('role', 'alert').html('Link saved');
                        setTimeout(function(){ alert.remove(); }, 5000);
                        $('body').append(alert.fadeIn());
                    },
                    error: function(data){
                        modal.modal('hide');
                        var alert = $('<div>').addClass('alert alert-danger toast').attr('role', 'alert').html('Link saved');
                        setTimeout(function(){ alert.remove(); }, 5000);
                        $('body').append(alert.fadeIn());
                    }
                });
                return false;
            });
        }
    });
    return false;
});
</script>
{% endblock javascripts %}