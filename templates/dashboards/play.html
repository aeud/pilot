{% extends "base.html" %}

{% load pipeline %}

{% block stylesheets %}
{{ block.super }}
{% stylesheet 'dashboards_play' %}
<style>

</style>
{% endblock stylesheets %}

{% block title %}Dashboard {{ dashboard.name }}{% endblock title %}
{% block h1 %}{{ dashboard.name }}{% endblock h1 %}

{% block breadcrumbs_nav %}
<div class="control pull-right">
    <div class="btn-group">
        <button type="button" class="btn-control dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="material-icons">more_horiz</i>
        </button>
        <ul class="dropdown-menu dropdown-menu-right">
            {% if request.user.is_staff %}
            <li><a href="{% url 'dashboards_edit' dashboard.id %}">Edit</a></li>
            <li><a href="{% url 'dashboards_visualizations_new' dashboard.id %}">Add a visualization</a></li>
            {% if dashboard_entities|length > 1 %}
            <li><a href="{% url 'dashboards_sort' dashboard.id %}">Sort</a></li>
            {% endif %}
            <li role="separator" class="divider"></li>
            {% endif %}
            {% if request.user in dashboard.star_users.all %}
            <li><a href="{% url 'dashboards_unstar' dashboard.id %}">Unstar</a></li>
            {% else %}
            <li><a href="{% url 'dashboards_star' dashboard.id %}">Star</a></li>
            {% endif %}
        </ul>
    </div>
</div>
<ol class="breadcrumb">
    <li><a href="{% url 'dashboards_index' %}">Dashboards</a></li>
    <li class="active">{{ dashboard.name }}</li>
</ol>
{% endblock breadcrumbs_nav %}

{% block header %}
{{ block.super }}
<div class="star visible-md visible-lg">
    {% if request.user in dashboard.star_users.all %}
    <a href="{% url 'dashboards_unstar' dashboard.id %}">
        <i class="material-icons">star</i>
        <i class="material-icons hover">star_border</i>
    </a>
    {% else %}
    <a href="{% url 'dashboards_star' dashboard.id %}">
        <i class="material-icons">star_border</i>
        <i class="material-icons hover">star</i>
    </a>
    {% endif %}
</div>
{% endblock header %}

{% block container %}
{% include "dashboards/_play_row.html" %}
{% endblock container %}

{% block javascripts %}
{{ block.super }}
<script>
var k = new Array();
$('.dashboard-entity-container').each(function(_i, el){
    var el = $(el);
    k.push(new Array(_i + 1, el.data('id')));
});
</script>
<script>
$('.chart').prepend($('<div>').attr('class', 'spinner').append($('<div>').attr('class', 'dot1')).append($('<div>').attr('class', 'dot2')));
google.load('visualization', '1');
function buildDataTable(s3URL, callback){
    $.ajax({
        url: s3URL,
        success: function(data){
            callback(data.rows);
        }
    });
}
function execute(el){
    $.ajax({
        url: el.data('url'),
        success: function(data){
            buildDataTable(data.url, function(array){
                if (array[0]) {
                    var headers = array[0];
                    headers.forEach(function(h, _i){
                        if (typeof h == 'object' && h.type && h.type == 'date') {
                            array.forEach(function(row, _j){
                                if (_j > 0) {
                                    if (typeof array[_j][_i] == 'object') {
                                        array[_j][_i].v = new Date(array[_j][_i].v);
                                    } else {
                                        array[_j][_i] = new Date(array[_j][_i]);
                                    }
                                }
                            });
                        }
                    });
                }
                var options = {}
                if (el.data('options-isstacked')) options.isStacked = el.data('options-isstacked');
                if (!options.width) options.width = '100%';
                if (!options.height) options.height = 400;
                google.visualization.drawChart({
                    containerId: el.data('location'),
                    dataTable: google.visualization.arrayToDataTable(array),
                    chartType: el.data('chart'),
                    options: options
                });
                el.removeClass('wait');
            });
            el.find('ul.dropdown-menu').append($('<li>').attr('class', 'divider')).append($('<li>').append($('<a>').attr('href', data.export_url).html('Download')));
        }
    });
}
function drawVisualization() {
    var _i = 0;
    var top = $(window).scrollTop();
    var bottom = $(window).scrollTop() + $(window).height();
    var map = $('.dashboard-entity-container').map(function(_i, el){
        var el = $(el);
        return {
            top: el.offset().top,
            bottom: el.offset().top + el.height(),
            el: el,
            loading: false,
            index: _i++
        }
    }).toArray();
    function processScroll() {
        var top = $(this).scrollTop();
        var bottom = $(this).scrollTop() + $(this).height();
        map.filter(function(d){ return !d.loading; }).forEach(function(d){
            if (d.bottom >= top && d.top <= bottom) {
                map[d.index].loading = true;
                execute(d.el);
            }
        });
    }
    $(window).scroll(processScroll);
    processScroll();
{% comment %}
    {% for dashboard_entity in dashboard_entities %}
    $.ajax({
        url: '{% url 'visualizations_execute' dashboard_entity.visualization.id %}',
        success: function(data){
            buildDataTable(data.url, function(array){
                if (array[0]) {
                    var headers = array[0];
                    headers.forEach(function(h, _i){
                        if (typeof h == 'object' && h.type && h.type == 'date') {
                            array.forEach(function(row, _j){
                                if (_j > 0) {
                                    if (typeof array[_j][_i] == 'object') {
                                        array[_j][_i].v = new Date(array[_j][_i].v);
                                    } else {
                                        array[_j][_i] = new Date(array[_j][_i]);
                                    }
                                }
                            });
                        }
                    });
                }
                {% if dashboard_entity.visualization.graph.map_script %}
                array = ({{ dashboard_entity.visualization.graph.map_script|safe }})(array);
                {% endif %}
                {% if dashboard_entity.visualization.graph.options %}
                var options = {{ dashboard_entity.visualization.graph.options|safe }};
                {% else %}
                var options = {}
                {% endif %}
                if (!options.width) options.width = '100%';
                if (!options.height) options.height = 400;
                google.visualization.drawChart({
                    containerId: 'v_{{ dashboard_entity.visualization.id }}',
                    dataTable: google.visualization.arrayToDataTable(array),
                    chartType: '{{ dashboard_entity.visualization.graph.chart_type }}',
                    options: options
                });
                $('#w_{{ dashboard_entity.visualization.id }}').removeClass('wait');
            });
            $('#w_{{ dashboard_entity.visualization.id }}').find('ul.dropdown-menu').append($('<li>').attr('class', 'divider')).append($('<li>').append($('<a>').attr('href', data.export_url).html('Download')));
        }
    });
    {% endfor %}
{% endcomment %}
}
google.setOnLoadCallback(drawVisualization);
</script>
{% endblock javascripts %}